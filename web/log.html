<!DOCTYPE html>
<html>
<head>
    <title>日志</title>
    <meta charset="utf-8" />

    <link href="js/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="js/bootstrap-table/bootstrap-table.min.css" rel="stylesheet" />

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap/bootstrap.min.js"></script>
    <script src="js/bootstrap-table/bootstrap-table.min.js"></script>
    <script src="js/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
    <script src="js/layer/layer.js"></script>
    <script src="js/laydate/laydate.js"></script>
    <script src="js/json-viewer/jquery.json-viewer.js"></script>
    <link href="js/json-viewer/jquery.json-viewer.css" rel="stylesheet" />

    <style>
        .logs-wrap {
            width:100%;
        }
        pre > a.json-toggle:before {
            left: -0.8em;
        }

        .panel > .panel-heading {
            border-left: 1px solid #ddd;
        }

        .panel .glyphicon-chevron-up,
        .panel .collapsed .glyphicon-chevron-down {
            display: inline-block;
            *display: inline;
            *zoom: 1;
        }

        .panel .glyphicon-chevron-down,
        .panel .collapsed .glyphicon-chevron-up {
            display: none;
        }

        .tool-bar select {
            font-size: 14px;
            padding: 7px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            vertical-align: middle;
            margin-left: 5px;
        }

        .input-group {
            margin-bottom: 7px;
        }

    

    </style>

</head>
<body>

    <div class="container logs-wrap">
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="panel panel-default" style="margin:10px auto;">
                    <div class="panel-heading">
                        <span class="panel-title">查询</span>
                        <span class="pull-right" role="button" data-toggle="collapse" data-target="#log_db_search" style="color:#ababab;padding-top: 1px;">
                            <i class="glyphicon glyphicon-chevron-up" title="收起"></i>
                            <i class="glyphicon glyphicon-chevron-down" title="展开"></i>
                        </span>
                    </div>
                    <div class="panel-body collapse in" id="log_db_search">
                        <div class="container" style="width:100%;">
                            <div class="row">
                                <div class="col-sm-6 col-md-6">
                                    <div class="input-group">
                                        <div class="input-group-addon">日期</div>
                                        <input type="text" class="form-control" name="Date" value="">
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-6">
                                    <div class="input-group">
                                        <div class="input-group-addon">等级</div>
                                        <select class="form-control" name="Level" >
                                            <option value="">请选择</option>
                                            <option value="debug">debug</option>
                                            <option value="trace">trace</option>
                                            <option value="error">error</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="toolbar" class="tool-bar">
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-info" onclick="showLogsList()">查看日志</button>
                    </div>
                    <select id="year" title="年份">
                        <option value="">年份</option>
                    </select>

                    <select id="month" title="月份">
                        <option value="">月份</option>
                        <option value="01">1</option>
                        <option value="02">2</option>
                        <option value="03">3</option>
                        <option value="04">4</option>
                        <option value="05">5</option>
                        <option value="06">6</option>
                        <option value="07">7</option>
                        <option value="08">8</option>
                        <option value="09">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>



                </div>
                <table id="search_table"></table>
            </div>
        </div>
    </div>
    <script>

        //获取来自地址栏（URL）中的一个参数值
        function getQueryString(key) {
            /// <summary>获取来自地址栏（URL）中的某个参数值</summary>
            /// <param name="key" type="String">参数名称</param>
            /// <returns type="String" />
            var regExp = new RegExp("[\?|\&]" + key + "=([^&]+)"); //  new RegExp("[\?\&]" + key + "=([^\&]+)(&|$)");
            var matchStrings = window.location.search.match(regExp);
            return matchStrings && decodeURIComponent(matchStrings[1]);
        }

        //字符串的format 调用方法如："第一名是{0}, 第二名是{1}".format("张三", "王五")); 'name={name},sex={sex}'.format({name:'xxx',sex:1});
        String.prototype.format = function () {
            var args = arguments;
            //如果第一个参数是对象
            var isObject = typeof (args[0]) === 'object';
            var re = isObject ? /\{(\w+)\}/g : /\{(\d+)\}/g;
            var isNull = function (value) {
                if (typeof (value) === 'object') {
                    return JSON.stringify(value) || "";
                }
                return value == null ? "" : value;
            };
            return this.replace(re, function (m, key) {
                if ((isObject && args[0][key] === undefined) || (!isObject && args[key] === undefined)) {
                    return "{" + key + "}";
                }
                return isObject ? isNull(args[0][key]) : isNull(args[key]);
            });
        };

        //去除字符串两端的空格
        String.prototype.trim = function () {
            return this.replace(/(^\s*)|(\s*$)/g, '');
        };

        //数字的四舍五入
        Number.prototype.round = function (number) {
            return Math.round(this * Math.pow(10, number)) / Math.pow(10, number);
        };

        //全局唯一标识符GUID,类似.net中的NewID();
        function guid() {
            function S4() {
                return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
            }
            return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
        }
        //数据容量单位转换(kb,mb,gb,tb)
        function getFileSize(fileSize, withUnit) {

            if (fileSize === 0) return '0 B';
            var k = 1024,
                sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
                i = Math.floor(Math.log(fileSize) / Math.log(k));

            if (!Number.prototype.round) {
                Number.prototype.round = function (number) {
                    return Math.round(this * Math.pow(10, number)) / Math.pow(10, number);
                };
            }

            withUnit = typeof (withUnit) === "undefined" ? true : withUnit;
            if (withUnit) {
                return (fileSize / Math.pow(k, i)).round(2) + ' ' + sizes[i];
            }
            else {
                return (fileSize / Math.pow(k, i)).round(2);
            }

        }


    </script>
    <script>
        var _ApiHost = 'http://localhost:20572';

        $(function () {
            LogHelper.init(function () {
                this.refresh();
            });
         
        });

        
        //检测步骤
        var LogHelper = (function () {
            var _log_action="", $table;

            var _dal = {
                "GetLogList": function (year, month, callback) {
                    $.ajax({
                        url: _ApiHost + "/Log/SearchLogDbFiles",
                        type: "get",
                        data: { "year": year, "month": month, "log_action": _log_action },
                        dataType: "json",
                        success: function (res) {
                            callback(res || []);
                        }
                    });
                }
                
            };

            
            function init(callback) {
                var _this = this;
                
                _log_action = getQueryString("log_action") || "";
                $table = $("#search_table");

                var now = new Date(), currentYrear = now.getFullYear(), _selectHtml = ['<option value="">年份</option>'], _endYear = 2018;
                for (var _year = currentYrear; _year >= _endYear; _year--) {
                    _selectHtml.push('<option value="{0}" {1}>{0}</option>'.format(_year, _year == currentYrear ? 'selected="selected"' : ''));
                }
                $("#year").html(_selectHtml.join(''));

                var mon = "00"+(now.getMonth() + 1);
                $("#month").val(mon.substr(mon.length-2,2));

                $("#year,#month").change(function () { refresh(); });

                $table.bootstrapTable({
                    toolbar: '#toolbar',         
                    striped: true,               
                    cache: false, 
                    pagination: true,            
                    sidePagination: "client",    
                    pageNumber: 1,               
                    pageSize: 10,                
                    pageList: [10,15,20, 30, 40, 50, 75, 100],  

                    sortable: true,           
                    
                    search: true,             
                    showColumns: true,        
                    showRefresh: true,        
                    minimumCountColumns: 2,   
                    uniqueId: "fileName",     
                    onRefresh: function (params) { refresh(); },
                    onSearch: function (text) { },
                    columns: [
                        { checkbox: true },
                        //{
                        //    //field: 'operate',
                        //    //title: '操作',
                        //    align: 'center',
                        //    width: '60px',
                        //    events: {
                        //        "click .btn-log": function (event, value, row, index) {
                        //            showLogsList(row);
                        //        }
                                
                        //    },
                        //    formatter: function (value, row, index) {

                        //        var btn_tmpl = ['<div class="btn-group">'];

                        //        btn_tmpl.push('<button type="button" class="btn btn-info btn-xs btn-log" >查看日志</button>');

                        //        btn_tmpl.push('</div>');

                        //        return btn_tmpl.join('');
                        //    }
                        //},
                        {
                            title: '序号',
                            width: '60px',
                            align: 'center',
                            formatter: function (value, row, index) {
                                return index + 1;
                            }
                        },
                        
                        
                        //{ field: 'year', title: '年份', align: 'center', width: '100px', sortable: true },
                        //{
                        //    field: 'month', title: '月份', align: "center", width: '100px', sortable: true
                        //    , formatter: function (value, row, index) {
                        //        return parseInt(value) || value;
                        //    }
                        //},
                        { field: 'date', title: '日期', align: 'center', width: '100px', sortable: true },
                        { field: 'level', title: '等级', width: '100px', sortable: true },
                        { field: 'fileName', title: '文件名', width: '200px', sortable: true },
                        
                        
                        {
                            field: 'fileSize', title: '文件大小', align: "center", width: '100px', sortable: true
                            , formatter: function (value, row, index) {
                                return getFileSize(value);
                            }
                        },
                        { field: 'fileUpdateTime', title: '更新时间', align: "center", width: '150px', sortable: true },
                        { field: 'filePath', title: '文件Path', sortable: true, visible: true }
                    ]

                    , detailView: true
                    , onExpandRow: function (index, row, $detail) {
                        var _LogFile = new LogFile();
                        _LogFile.init(index, row, $detail, function () {
                            this.loadList();
                        });
                    }

                });

                if (callback) {
                    callback.call(_this);
                }

            }

            //刷新
            function refresh() {
                _dal.GetLogList($("#year").val(), $("#month").val(), function (rData) {
                    console.log(rData);
                    $table.bootstrapTable("load", rData);
                });
            }

            
            return {
                init: init,
                refresh: refresh
            };


        }());

        //日志 
        function LogFile() {
            var _log_action = "", _rowData, $detailTable;
            //接口
            var _dal = {
                "GetLogDataList": function (path, callback) {
                    $.ajax({
                        url: _ApiHost + "/Log/GetLogs",
                        type: "get",
                        data: { "path": path },
                        dataType: "json",
                        success: function (res) {
                            callback(res || []);
                        }
                    });
                }
                , "GetLogData": function (path,id, callback) {
                    $.ajax({
                        url: _ApiHost + "/Log/GetLogData",
                        type: "get",
                        data: { "path": path, "id": id },
                        dataType: "json",
                        success: function (res) {
                            callback(res || []);
                        }
                    });
                }
            };

            function init(rowIndex, rowData, $detail, callback) {
                
                _rowData = rowData;
                _log_action = getQueryString("log_action") || "";
                var _tmpl = [
                    '<div style="padding-bottom:10px;">',
                        '<h3 style="text-align: center;">{0}</h3>'.format(rowData.fileName),
                        '<table id="detail_{0}"></table>'
                    , '</div>'
                ].join("");
                $detail.html(_tmpl.format(rowIndex));
                $detailTable = $detail.find("#detail_" + rowIndex);

                $detailTable.bootstrapTable({
                    striped: true,                    
                    cache: false,                     
                    pagination: true,                 
                    sortable: true,                   
                    //sortName: "CreateTime",
                    //sortOrder: "asc",               
                    sidePagination: "client",         
                    pageNumber: 1,                    
                    pageSize: 5,                      
                    pageList: [5,10, 15, 25, 35, 50, 75, 100],    
                    search: true,                
                    showColumns: true,           
                    showRefresh: true,           
                    minimumCountColumns: 2,               
                    onRefresh: function (params) { loadList(); },
                    columns: [

                        {
                            title: '序号', width: '40px', align: 'center',
                            formatter: function (value, row, index) {
                                return index + 1;
                            }
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "40px"
                                    }
                                };
                            }
                        },
                        {
                            title: '信息详情', align: 'center', width: '110px',
                            events: {
                                "click .btn-msg": function (event, value, row, index) {

                                    layer.open({
                                        title: "信息详情_" + (index + 1)
                                        , type: 1 //iframe
                                        , area: ['40%', '60%']
                                        , maxmin: true
                                        , success: function (layero, layerIndex) {
                                            // layer.full(index);
                                        }
                                        , content: '<div style="padding:10px;">' + (row.Message + "").replace(/\<br\/\>/g, '<br/><br/>') + '</div>'
                                    });

                                }
                                , "click .btn-data": function (event, value, row, index) {

                                    _dal.GetLogData(_rowData.filePath, row.ID, function (rDatas) {
                                        var _dataStr = (((rDatas[0] || {}).Data || "") + "").replace(/\<br\/\>/g, '<br/><br/>');
                                        if (!_dataStr) {
                                            layer.msg("没有相关数据", { time: 600 }); return false;
                                        }

                                        layer.open({
                                            title: "数据详情_" + (index + 1)
                                            , type: 1
                                            , area: ['98%', '98%']
                                            , scrollbar: false
                                            , maxmin: true
                                            , content: '<div class="content" style="padding:10px;">' + _dataStr + '</div>'
                                            , success: function (layero, layerIndex) {
                                                // layer.full(index);
                                                try {
                                                    var dataJson = JSON.parse(_dataStr);
                                                    layero.find('.content').html('<pre class="json-renderer" style="padding:10px;" ></pre>');

                                                    layero.find('.json-renderer').jsonViewer(dataJson, { collapsed: false, withQuotes: true, withLinks: false });

                                                }
                                                catch (e) {
                                                    layero.find('.content').html(_dataStr);
                                                }



                                            }

                                        });
                                    });



                                }
                                
                            },
                            formatter: function (value, row, index) {
                                var btnTmpl = [];

                                btnTmpl.push('<div class="btn-group">');
                                btnTmpl.push('<button type="button" class="btn btn-success btn-sm btn-msg" >信息</button>');
                                btnTmpl.push('<button type="button" class="btn btn-info btn-sm btn-data" >数据</button>');
                                btnTmpl.push('</div>');

                                return btnTmpl.join("");
                            }
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "110px"
                                    }
                                };
                            }
                            
                        },
                        {
                            field: 'Time', title: '时间', width: '150px', align: 'center', sortable: true
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "150px"
                                    }
                                };
                            }
                        },
                        {
                            field: 'Level', title: '等级', width: '85px', align: 'center', sortable: true
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "85px"
                                    }
                                };
                            }
                        },
                        {
                            field: 'Type', title: '类型', width: '160px', sortable: true
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "160px"
                                    }
                                };
                            }
                        },
                        {
                            field: 'UserIP', title: '访问IP', width: '90px', sortable: true
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "90px"
                                    }
                                };
                            }
                        },
                        {
                            field: 'UserID', title: '操作人ID', width: '90px', sortable: true
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "90px"
                                    }
                                };
                            }
                        },
                        {
                            field: 'UserName', title: '操作人', width: '120px', sortable: true
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "120px"
                                    }
                                };
                            }
                        }
                        //信息
                        , {
                            field: 'Message', title: '信息', width: '300px',
                            formatter: function (value, row, index) {
                                return '<div style="max-width:280px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;">' + (value+"").replace(/\<br\/\>/g,' ') + '</div>';
                            }
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "300px"
                                    }
                                };
                            }
                        }
                       

                    ]
                });







                if (callback) {
                    callback.call(this);
                }

            }

            function loadList() {
                _dal.GetLogDataList(_rowData.filePath, function (rData) {
                    $detailTable.bootstrapTable("load", rData);
                });

            }

            return {
                init: init,
                loadList: loadList
            };


        }





        //显示
        function showLogsList(row) {



            var tableID = guid();
            var toolID = guid();

            //tmpl
            {
                var tmpl = ['<div class="labware-list-wrap" style="padding:10px 10px 80px 10px;">'];

                tmpl.push('<div class="panel panel-default" style="margin-bottom:10px;">');
                tmpl.push('<div class="panel-heading"><span class="panel-title">查询</span>');
                tmpl.push('<span class="pull-right" role="button" data-toggle="collapse" data-target="#sample_search_{0}" style="color:#ababab;padding-top: 1px;">'.format(toolID));
                tmpl.push('<i class="glyphicon glyphicon-chevron-up" title="收起"></i><i class="glyphicon glyphicon-chevron-down" title="展开"></i></span></div>');
                tmpl.push('<div class="panel-body collapse in search-wrap " id="sample_search_{0}">'.format(toolID));
                tmpl.push('<div class="container" style="width:100%;"><div class="row">');


                tmpl.push('<div class="col-sm-4 col-md-4"><div class="input-group"><div class="input-group-addon">时间</div>');
                tmpl.push('<input type="text" class="form-control" name="Time" value="" /></div></div>');

                tmpl.push('<div class="col-sm-4 col-md-4"><div class="input-group"><div class="input-group-addon">等级</div>');
                tmpl.push('<select class="form-control" name="Level"><option value="">请选择</option></select></div></div>');

                tmpl.push('<div class="col-sm-4 col-md-4"><div class="input-group"><div class="input-group-addon">类型</div>');
                tmpl.push('<input type="text" class="form-control" name="Type" value="" /></div></div>');

                tmpl.push('<div class="col-sm-4 col-md-4"><div class="input-group"><div class="input-group-addon">访问IP</div>');
                tmpl.push('<input type="text" class="form-control" name="UserIP" value="" /></div></div>');

                tmpl.push('<div class="col-sm-4 col-md-4"><div class="input-group"><div class="input-group-addon">操作人ID</div>');
                tmpl.push('<input type="text" class="form-control" name="UserID" value="" /></div></div>');

                tmpl.push('<div class="col-sm-4 col-md-4"><div class="input-group"><div class="input-group-addon">操作人</div>');
                tmpl.push('<input type="text" class="form-control" name="UserName" value="" /></div></div>');

                tmpl.push('<div class="col-sm-4 col-md-4"><div class="input-group"><div class="input-group-addon">信息</div>');
                tmpl.push('<input type="text" class="form-control" name="Message" value="" /></div></div>');

                tmpl.push('<div class="col-sm-4 col-md-4"><div class="input-group"><div class="input-group-addon">数据</div>');
                tmpl.push('<input type="text" class="form-control" name="Data" value="" /></div></div>');


                tmpl.push('</div></div></div></div>');

                tmpl.push('<div id="{0}" class="tool-bar"><div class="btn-group">'.format(toolID));
                tmpl.push('<button class="btn btn-success btn-logs-search">查询</button>');
                tmpl.push('</div></div><table id="{0}"></table>'.format(tableID));


                tmpl.push('</div>');
            }


            layer.open({
                title: '<b><i class="glyphicon glyphicon-erase"></i>&nbsp;“{fileName}”的日志列表</b>'.format(row)
                , type: 1
                , maxmin: true
                , shade: 0
                , scrollbar:false

                , content: tmpl.join("")
                , area: ["98%", "98%"]
                , success: function (layero, layerIndex) {
                    //layer.full(layerIndex);
                    var $logTable = $("#" + tableID);
                    var _toolbarMoreSelect = "#" + toolID;

                    $logTable.bootstrapTable({

                        toolbar: _toolbarMoreSelect,    
                        striped: true,                  
                        cache: false,
                        pagination: false,              
                        sidePagination: "client",       
                        pageNumber: 1,                  
                        pageSize: 10,                   
                        pageList: [10, 30, 50, 70, 100, 150, 200, 250, 300, 400, 500],

                        sortable: true,               
                        
                        search: false,                 
                        showColumns: true,            
                        showRefresh: true,            
                        minimumCountColumns: 2,       
                        uniqueId: "ID",            
                        onRefresh: function (params) {
                            loadLogs();
                        },
                        onSearch: function (text) { },
                        onPostBody: function () {

                        },
                        columns: [
                            //{ checkbox: true },
                            {
                                //field: 'operate',
                                //title: '操作',
                                align: 'center',
                                width: '120px',
                                events: {
                                    "click .btn-info": function (event, value, row, index) {
                                        
                                    }
                                    , "click .btn-data": function (event, value, row, index) {

                                    }

                                },
                                formatter: function (value, row, index) {

                                    var btn_tmpl = ['<div class="btn-group">'];

                                    btn_tmpl.push('<button type="button" class="btn btn-info btn-sm btn-info" >信息</button>');

                                    btn_tmpl.push('<button type="button" class="btn btn-success btn-sm btn-data" >数据</button>');

                                    btn_tmpl.push('</div>');

                                    return btn_tmpl.join('');
                                }
                            },
                            { field: 'index', width: '40px', align: 'center', formatter: function (value, row, index) { return index + 1; } },
                            
                            { field: 'Time', title: '时间', sortable: true },
                            { field: 'Level', title: '等级', sortable: true },
                            { field: 'Type', title: '类型', sortable: true },
                            { field: 'UserIP', title: '访问IP', sortable: true },
                            { field: 'UserID', title: '操作人ID', sortable: true },
                            { field: 'UserName', title: '操作人', sortable: true },
                            { field: 'Message', title: '信息', sortable: true }

                        ]


                    });

                    //加载数据
                    var loadLogs = function () {
                        
                    };
                    loadLogs();

                    //查询
                    layero.find('.btn-logs-search').click(function () {
                        loadLogs();
                    });














                }

            });

        }





















    </script>


</body>
</html>
