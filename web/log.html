<!DOCTYPE html>
<html>
<head>
    <title>日志</title>
    <meta charset="utf-8" />
    <!--清除缓存-->
    <meta HTTP-EQUIV="Pragma" CONTENT="no-cache">
    <meta HTTP-EQUIV="Cache-Control" CONTENT="no-cache">
    <meta HTTP-EQUIV="Expires" CONTENT="0">

    <link href="js/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="js/bootstrap-table/bootstrap-table.min.css" rel="stylesheet" />

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap/bootstrap.min.js"></script>
    <script src="js/bootstrap-table/bootstrap-table.min.js"></script>
    <script src="js/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
    <script src="js/layer/layer.js"></script>
    <script src="js/laydate/laydate.js"></script>
    <script src="js/json-viewer/jquery.json-viewer.js"></script>
    <link href="js/json-viewer/jquery.json-viewer.css" rel="stylesheet" />

    <style>

        pre > a.json-toggle:before {
            left: -0.8em;
        }
    </style>

</head>
<body>

    <div class="container logs-wrap">
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div id="toolbar" class="tool-bar">
                    
                    <select id="year" title="年份">
                        <option value="">年份</option>
                        <option value="2018" selected="selected">2018</option>
                        <option value="2017">2017</option>
                        <option value="2016">2016</option>
                    </select>

                    <select id="month" title="月份">
                        <option value="">月份</option>
                        <option value="01">1</option>
                        <option value="02">2</option>
                        <option value="03">3</option>
                        <option value="04">4</option>
                        <option value="05">5</option>
                        <option value="06">6</option>
                        <option value="07">7</option>
                        <option value="08">8</option>
                        <option value="09">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                </div>
                <table id="search_table"></table>
            </div>
        </div>
    </div>

    <script>

        $(function () {
            LogHelper.init(function () {
                this.refresh();
            });
         
        });


        //检测步骤
        var LogHelper = (function () {
            var _ApiHost = "", _log_action="", $table;

            var _dal = {
                "GetLogList": function (year, month, callback) {
                    $.ajax({
                        url: _ApiHost + "/Log/List",
                        type: "get",
                        data: { "year": year, "month": month, "log_action": _log_action },
                        dataType: "json",
                        success: function (res) {
                            if (res.success) {
                                callback(res.data || []);
                            }
                            else {
                                layer.alert(res.message);
                            }
                        }
                    });
                }
                , "GetLogData": function (fileName, callback) {
                    $.ajax({
                        url: _ApiHost + "/Log/Read",
                        type: "get",
                        data: { "fileName": fileName, "log_action": _log_action },
                        dataType: "json",
                        success: function (res) {
                            if (res.success) {
                                callback(res.data || []);
                            }
                            else {
                                layer.alert(res.message);
                            }
                        }
                    });
                }
            };

            //数据容量单位转换(kb,mb,gb,tb)
            function getFileSize(fileSize, withUnit) {

                if (fileSize === 0) return '0 B';
                var k = 1024,
                    sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
                    i = Math.floor(Math.log(fileSize) / Math.log(k));

                if (!Number.prototype.round) {
                    Number.prototype.round = function (number) {
                        return Math.round(this * Math.pow(10, number)) / Math.pow(10, number);
                    };
                }

                withUnit = typeof (withUnit) === "undefined" ? true : withUnit;
                if (withUnit) {
                    return (fileSize / Math.pow(k, i)).round(2) + ' ' + sizes[i];
                }
                else {
                    return (fileSize / Math.pow(k, i)).round(2);
                }

            }


            function init(callback) {
                var _this = this;
                _ApiHost = ApiHost;
                _log_action = getQueryString("log_action") || "";
                $table = $("#search_table");

                var now = new Date(), currentYrear = now.getFullYear(), _selectHtml = ['<option value="">年份</option>'], _endYear = 2016;
                for (var _year = currentYrear; _year >= _endYear; _year--) {
                    _selectHtml.push('<option value="{0}" {1}>{0}</option>'.format(_year, _year == currentYrear ? 'selected="selected"' : ''));
                }
                $("#year").html(_selectHtml.join(''));

                var mon = "00"+(now.getMonth() + 1);
                $("#month").val(mon.substr(mon.length-2,2));

                $("#year,#month").change(function () { refresh(); });

                $table.bootstrapTable({
                    toolbar: '#toolbar',         
                    striped: true,               
                    cache: false, 
                    pagination: true,            
                    sidePagination: "client",    
                    pageNumber: 1,               
                    pageSize: 10,                
                    pageList: [10,15,20, 30, 40, 50, 75, 100],  

                    sortable: true,           
                    
                    search: true,             
                    showColumns: true,        
                    showRefresh: true,        
                    minimumCountColumns: 2,   
                    uniqueId: "fileName",     
                    onRefresh: function (params) { refresh(); },
                    onSearch: function (text) { },
                    columns: [
                        {
                            title: '序号',
                            width: '60px',
                            align: 'center',
                            formatter: function (value, row, index) {
                                return index + 1;
                            }
                        },
                        
                        
                        { field: 'year', title: '年份', align: 'center', width: '100px', sortable: true },
                        {
                            field: 'month', title: '月份', align: "center", width: '100px', sortable: true
                            , formatter: function (value, row, index) {
                                return parseInt(value) || value;
                            }
                        },
                        { field: 'fileName', title: '文件名', sortable: true },
                        { field: 'filePath', title: '文件Path', sortable: true,visible:false },
                        { field: 'fileUpdateTime', title: '更新时间', align: "center", sortable: true },
                        {
                            field: 'fileSize', title: '文件大小', align: "center", sortable: true
                            , formatter: function (value, row, index) {
                                return getFileSize(value);
                            }
                        }
                        
                    ]

                    , detailView: true
                    , onExpandRow: function (index, row, $detail) {
                        var _LogFile = new LogFile();
                        _LogFile.init(index, row, $detail, function () {
                            this.loadList();
                        });
                    }

                });

                if (callback) {
                    callback.call(_this);
                }

            }

            //刷新
            function refresh() {
                _dal.GetLogList($("#year").val(), $("#month").val(), function (rData) {
                    $table.bootstrapTable("load", rData);
                });
            }

            
            return {
                init: init,
                refresh: refresh
            };


        }());

        //日志 
        function LogFile() {
            var _ApiHost, _log_action = "", _rowData, $detailTable;
            //接口
            var _dal = {
                "GetLogDataList": function (filePath, callback) {
                    $.ajax({
                        url: _ApiHost + "/Log/Read",
                        type: "get",
                        data: { "filePath": filePath, "log_action": _log_action },
                        dataType: "json",
                        success: function (res) {
                            if (res.success) {
                                callback(res.data || []);
                            }
                            else {
                                layer.alert(res.message);
                            }
                        }
                    });
                }
                , "GetLogData": function (filePath,ID, callback) {
                    $.ajax({
                        url: _ApiHost + "/Log/GetLogData",
                        type: "get",
                        data: { "filePath": filePath, "ID": ID, "log_action": _log_action },
                        dataType: "json",
                        success: function (res) {
                            if (res.success) {
                                callback(res.data || []);
                            }
                            else {
                                layer.alert(res.message);
                            }
                        }
                    });
                }
            };

            function init(rowIndex, rowData, $detail, callback) {
                _ApiHost = ApiHost;
                _rowData = rowData;
                _log_action = getQueryString("log_action") || "";
                var _tmpl = [
                    '<div style="padding-bottom:10px;">',
                        '<h3 style="text-align: center;">{0}</h3>'.format(rowData.fileName),
                        '<table id="detail_{0}"></table>'
                    , '</div>'
                ].join("");
                $detail.html(_tmpl.format(rowIndex));
                $detailTable = $detail.find("#detail_" + rowIndex);

                $detailTable.bootstrapTable({
                    striped: true,                    
                    cache: false,                     
                    pagination: true,                 
                    sortable: true,                   
                    //sortName: "CreateTime",
                    //sortOrder: "asc",               
                    sidePagination: "client",         
                    pageNumber: 1,                    
                    pageSize: 5,                      
                    pageList: [5,10, 15, 25, 35, 50, 75, 100],    
                    search: true,                
                    showColumns: true,           
                    showRefresh: true,           
                    minimumCountColumns: 2,               
                    onRefresh: function (params) { loadList(); },
                    columns: [

                        {
                            title: '序号', width: '40px', align: 'center',
                            formatter: function (value, row, index) {
                                return index + 1;
                            }
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "40px"
                                    }
                                };
                            }
                        },
                        {
                            title: '信息详情', align: 'center', width: '110px',
                            events: {
                                "click .btn-msg": function (event, value, row, index) {

                                    layer.open({
                                        title: "信息详情_" + (index + 1)
                                        , type: 1 //iframe
                                        , area: ['40%', '60%']
                                        , maxmin: true
                                        , success: function (layero, layerIndex) {
                                            // layer.full(index);
                                        }
                                        , content: '<div style="padding:10px;">' + (row.Message + "").replace(/\<br\/\>/g, '<br/><br/>') + '</div>'
                                    });

                                }
                                , "click .btn-data": function (event, value, row, index) {

                                    _dal.GetLogData(_rowData.filePath, row.ID, function (rDatas) {
                                        var _dataStr = (((rDatas[0] || {}).Data || "") + "").replace(/\<br\/\>/g, '<br/><br/>');
                                        if (!_dataStr) {
                                            layer.msg("没有相关数据", { time: 600 }); return false;
                                        }

                                        layer.open({
                                            title: "数据详情_" + (index + 1)
                                            , type: 1
                                            , area: ['98%', '98%']
                                            , scrollbar: false
                                            , maxmin: true
                                            , content: '<div class="content" style="padding:10px;">' + _dataStr + '</div>'
                                            , success: function (layero, layerIndex) {
                                                // layer.full(index);
                                                try {
                                                    var dataJson = JSON.parse(_dataStr);
                                                    layero.find('.content').html('<pre class="json-renderer" style="padding:10px;" ></pre>');

                                                    layero.find('.json-renderer').jsonViewer(dataJson, { collapsed: false, withQuotes: true, withLinks: false });

                                                }
                                                catch (e) {
                                                    layero.find('.content').html(_dataStr);
                                                }



                                            }

                                        });
                                    });



                                }
                                
                            },
                            formatter: function (value, row, index) {
                                var btnTmpl = [];

                                btnTmpl.push('<div class="btn-group">');
                                btnTmpl.push('<button type="button" class="btn btn-success btn-sm btn-msg" >信息</button>');
                                btnTmpl.push('<button type="button" class="btn btn-info btn-sm btn-data" >数据</button>');
                                btnTmpl.push('</div>');

                                return btnTmpl.join("");
                            }
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "110px"
                                    }
                                };
                            }
                            
                        },
                        {
                            field: 'Time', title: '时间', width: '150px', align: 'center', sortable: true
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "150px"
                                    }
                                };
                            }
                        },
                        {
                            field: 'Level', title: '等级', width: '85px', align: 'center', sortable: true
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "85px"
                                    }
                                };
                            }
                        },
                        {
                            field: 'Type', title: '类型', width: '160px', sortable: true
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "160px"
                                    }
                                };
                            }
                        },
                        {
                            field: 'UserIP', title: '访问IP', width: '90px', sortable: true
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "90px"
                                    }
                                };
                            }
                        },
                        {
                            field: 'UserID', title: '操作人ID', width: '90px', sortable: true
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "90px"
                                    }
                                };
                            }
                        },
                        {
                            field: 'UserName', title: '操作人', width: '120px', sortable: true
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "120px"
                                    }
                                };
                            }
                        }
                        //信息
                        , {
                            field: 'Message', title: '信息', width: '300px',
                            formatter: function (value, row, index) {
                                return '<div style="max-width:280px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;">' + (value+"").replace(/\<br\/\>/g,' ') + '</div>';
                            }
                            , cellStyle: function (value, row, index) {
                                return {
                                    css: {
                                        "min-width": "300px"
                                    }
                                };
                            }
                        }
                       

                    ]
                });







                if (callback) {
                    callback.call(this);
                }

            }

            function loadList() {
                _dal.GetLogDataList(_rowData.filePath, function (rData) {
                    $detailTable.bootstrapTable("load", rData);
                });

            }

            return {
                init: init,
                loadList: loadList
            };


        }


    </script>


</body>
</html>
